# ğŸ§© ã‚³ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¸€è¦§

- Review UIï¼ˆæˆæ¥­ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰: `apps/review-page/app/course_reviews/page.tsx`
- Review UIï¼ˆä¼æ¥­ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰: `apps/review-page/app/company_reviews/page.tsx`
- QA APIï¼ˆæˆæ¥­ï¼‰: `apps/review-page/app/api/ask/route.ts`
- QA APIï¼ˆä¼æ¥­ï¼‰: `apps/review-page/app/api/company-ask/route.ts`
- Moderation API: `apps/review-page/app/api/review-moderation/route.ts`
- LINE Webhook: `apps/line-ai-bot/api/webhook.js`
- æ—§Botå®Ÿè£…ï¼ˆéå»ã®è©¦é¨“ã‚³ãƒ¼ãƒ‰ï¼‰: `apps/line-ai-bot/index.js`
- Subject Browser UI: `apps/subject-browser/app/page.tsx`
- Subject Browser API: `apps/subject-browser/app/api/public/*`

```mermaid
flowchart TD
  ReviewUI[Review UI] --> Moderation[/api/review-moderation]
  ReviewUI --> Reviews[/api/course-reviews]
  CompanyUI[Company UI] --> Moderation
  CompanyUI --> CompanyReviews[/api/company-reviews]
  LineWebhook[LINE Webhook] --> Ask[/api/ask or /api/review-ask]
  Ask --> Supabase[(Supabase)]
  SubjectUI[Subject Browser] --> SubjectAPI[/api/public/*]
  SubjectAPI --> Supabase
```

## Review UIï¼ˆæˆæ¥­ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰

- é€ä¿¡å‰ã« `/api/review-moderation` ã‚’å‘¼ã³å‡ºã—ã€AI åˆ¤å®šã§è­¦å‘Šã‚’å‡ºã™ã€‚

```ts
const moderationRes = await fetch('/api/review-moderation', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    fields: [
      { key: 'university', label: 'å¤§å­¦å', value: form.university.trim() },
      { key: 'courseName', label: 'ç§‘ç›®å', value: form.courseName.trim() },
      { key: 'comment', label: 'ã‚³ãƒ¡ãƒ³ãƒˆ', value: form.comment.trim() },
    ],
  }), // é€ä¿¡å‰ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’å¯©æŸ»
});
```
(å‚ç…§: apps/review-page/app/course_reviews/page.tsx:446-466)

## Review UIï¼ˆä¼æ¥­ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰

```ts
const moderationRes = await fetch('/api/review-moderation', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    fields: [
      { key: 'companyName', label: 'ä¼šç¤¾å', value: form.companyName.trim() },
      { key: 'bodyMain', label: 'æœ¬æ–‡', value: form.bodyMain.trim() },
    ],
  }), // ä¼æ¥­ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚åŒã˜å¯©æŸ»ãƒ•ãƒ­ãƒ¼
});
```
(å‚ç…§: apps/review-page/app/company_reviews/page.tsx:392-405)

## QA APIï¼ˆæˆæ¥­ï¼‰

- OpenAI Responses API ã¨ tools ã‚’ä½¿ã£ã¦ DB æ¤œç´¢ã‚’å¼·åˆ¶ã™ã‚‹ã€‚

```ts
const PROMPT_INSTRUCTIONS = `
ã‚ãªãŸã¯æˆæ¥­ãƒ¬ãƒ“ãƒ¥ãƒ¼DBã«åŸºã¥ãå›ç­”ã®ã¿è¡Œã†ã€‚
DBå‚ç…§ãŒå¿…è¦ãªè³ªå•ã§ã¯ã€å¿…ãš tools ã‚’å‘¼ã³å‡ºã—ã¦ã‹ã‚‰å›ç­”ã™ã‚‹ã€‚
`;
```
(å‚ç…§: apps/review-page/app/api/ask/route.ts:152-166)

## Moderation API

- ã‚³ãƒ¡ãƒ³ãƒˆ/å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ OpenAI ã§å¯©æŸ»ã—ã€JSON ã§è¿”ã™ã€‚

```ts
const resp = await openai.responses.create({
  model: MODERATION_MODEL, // å¯©æŸ»ãƒ¢ãƒ‡ãƒ«
  input: [
    { role: 'developer', content: prompt },
    { role: 'user', content: comment },
  ],
});
```
(å‚ç…§: apps/review-page/app/api/review-moderation/route.ts:105-113)

## LINE Webhook

- raw body ã§ç½²åæ¤œè¨¼ã—ã€Supabase ã«ä¼šè©±ãƒ­ã‚°ã‚’ä¿å­˜ã€‚

```js
function verifyLineSignature(rawBodyBuffer, signatureBase64, channelSecret) {
  const expected = crypto.createHmac('sha256', channelSecret)
    .update(rawBodyBuffer)
    .digest('base64');
  return crypto.timingSafeEqual(Buffer.from(signatureBase64), Buffer.from(expected));
}
```
(å‚ç…§: apps/line-ai-bot/api/webhook.js:36-44)

## Subject Browser

- å¤§å­¦ä¸€è¦§ â†’ ç§‘ç›®ä¸€è¦§ â†’ ç§‘ç›®è©³ç´°ã®3æ®µéšã§é–²è¦§ã€‚

```ts
const data = await fetchJson<{ ok: boolean; subjects: SubjectSummary[] }>(
  `/api/public/subjects?universityId=${selectedUniversityId}`
); // å¤§å­¦å˜ä½ã§ç§‘ç›®ã‚’å–å¾—
```
(å‚ç…§: apps/subject-browser/app/page.tsx:81-88)

æ¬¡ã«é€²ã‚€å ´åˆã¯ [APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](./07-APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
