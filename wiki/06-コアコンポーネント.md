# ğŸ§© ã‚³ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

## æ§‹æˆä¸€è¦§

- Review ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆLIFF + Next.jsï¼‰
- QA/DBæ¤œç´¢ (`/api/ask`)
- ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ (`/api/course-reviews`)
- ã‚³ãƒ¡ãƒ³ãƒˆå¯©æŸ» (`/api/review-moderation`)
- LINE Webhook (`apps/line-ai-bot/api/webhook.js`)

```mermaid
flowchart TD
  Form[Review Form]
  Form --> Moderation[Review Moderation API]
  Form --> ReviewsAPI[Course Reviews API]
  Webhook[LINE Webhook]
  Webhook --> Ask[Ask API]
```

## Review ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰

- é€ä¿¡å‰ã« `review-moderation` ã‚’å‘¼ã³å‡ºã—ã€è­¦å‘Šå¯¾è±¡ãªã‚‰ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

```tsx
const moderationRes = await fetch('/api/review-moderation', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ comment: form.comment.trim() }), // å…¥åŠ›ã‚³ãƒ¡ãƒ³ãƒˆ
});
```
(å‚ç…§: apps/review-page/app/page.tsx:399-405)

## QA/DBæ¤œç´¢ï¼ˆ/api/askï¼‰

- ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã§ tool å‘¼ã³å‡ºã—ã‚’å¼·åˆ¶ã™ã‚‹ä¿é™ºãƒ­ã‚¸ãƒƒã‚¯ã‚’å‚™ãˆã¦ã„ã¾ã™ã€‚

```ts
function shouldForceTool(userMessage: string) {
  const t = userMessage.toLowerCase();
  const keywords = ['æˆæ¥­', 'ç§‘ç›®', 'ãŠã™ã™ã‚', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼'];
  return keywords.some((k) => t.includes(k)); // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ tool ã‚’è¦æ±‚
}
```
(å‚ç…§: apps/review-page/app/api/ask/route.ts:127-155)

## ã‚³ãƒ¡ãƒ³ãƒˆå¯©æŸ» APIï¼ˆ/api/review-moderationï¼‰

```ts
const resp = await openai.responses.create({
  model: MODERATION_MODEL, // å¯©æŸ»ãƒ¢ãƒ‡ãƒ«
  input: [
    { role: 'developer', content: prompt },
    { role: 'user', content: comment },
  ],
});
```
(å‚ç…§: apps/review-page/app/api/review-moderation/route.ts:59-65)

## LINE Webhookï¼ˆline-ai-botï¼‰

- ç½²åæ¤œè¨¼ã‚„ raw body å–å¾—ã‚’è¡Œã„ã€LINE ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®‰å…¨ã«å‡¦ç†ã—ã¾ã™ã€‚

```js
function verifyLineSignature(rawBodyBuffer, signatureBase64, channelSecret) {
  const expected = crypto.createHmac("sha256", channelSecret)
    .update(rawBodyBuffer)
    .digest("base64");
  return crypto.timingSafeEqual(Buffer.from(signatureBase64), Buffer.from(expected));
}
```
(å‚ç…§: apps/line-ai-bot/api/webhook.js:34-42)

æ¬¡ã«é€²ã‚€å ´åˆã¯ [APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](./07-APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
