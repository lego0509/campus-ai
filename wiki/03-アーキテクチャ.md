# ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

## å…¨ä½“æ§‹æˆ

- review-page: LIFF ãƒ•ã‚©ãƒ¼ãƒ ã¨ API ã®ä¸­æ ¸ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ã€QAã€ãƒãƒƒãƒå®Ÿè¡Œã®å…¥å£ã€‚
- line-ai-bot: LINE Webhook å—ä¿¡ã€ç½²åæ¤œè¨¼ã€ä¼šè©±ãƒ­ã‚°ä¿å­˜ã€review-page API ã®å‘¼ã³å‡ºã—ã€‚
- subject-browser: å¤§å­¦/ç§‘ç›®ã®å…¬é–‹æ¤œç´¢ãƒšãƒ¼ã‚¸ã€‚

```mermaid
flowchart TD
  User[å­¦ç”Ÿ] -->|LIFF| ReviewUI[review-page UI]
  User -->|LINE| LineBot[line-ai-bot]
  ReviewUI --> ReviewAPI[review-page API]
  LineBot --> ReviewAPI
  ReviewAPI --> Supabase[(Supabase)]
  ReviewAPI --> OpenAI[OpenAI]
  Batch[Batch Jobs] --> Supabase
```

## ä¸»ãªè²¬å‹™åˆ†é›¢

- QAï¼ˆæˆæ¥­ï¼‰: `/api/ask` or `/api/review-ask` ãŒ OpenAI tools ã¨ Supabase æ¤œç´¢ã‚’çµ±åˆã€‚(å‚ç…§: apps/review-page/app/api/ask/route.ts:9-481)
- QAï¼ˆä¼æ¥­ï¼‰: `/api/company-ask` ãŒä¼æ¥­ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã® tools ã‚’æŒã¤ã€‚(å‚ç…§: apps/review-page/app/api/company-ask/route.ts:9-169)
- æŠ•ç¨¿: `/api/course-reviews` ã¨ `/api/company-reviews` ãŒ DB ã¸ã® upsert ã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¿å­˜ã‚’æ‹…å½“ã€‚(å‚ç…§: apps/review-page/app/api/course-reviews/route.ts:14-239, apps/review-page/app/api/company-reviews/route.ts:75-200)
- ä¸é©åˆ‡ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¤œçŸ¥: `/api/review-moderation` ãŒ OpenAI ã§åˆ¤å®šã€‚(å‚ç…§: apps/review-page/app/api/review-moderation/route.ts:6-194)

## ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼ˆLINEè³ªå•â†’å›ç­”ï¼‰

```mermaid
sequenceDiagram
  participant User as LINEãƒ¦ãƒ¼ã‚¶ãƒ¼
  participant Line as line-ai-bot
  participant Review as review-page /api/ask
  participant DB as Supabase
  participant AI as OpenAI

  User->>Line: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  Line->>Review: è³ªå•ã‚’è»¢é€
  Review->>AI: Responses API + tools
  AI-->>Review: function_call
  Review->>DB: tools å®Ÿè¡Œ
  DB-->>Review: æ¤œç´¢çµæœ
  Review->>AI: function_call_output
  AI-->>Review: å›ç­”
  Review-->>Line: è¿”ä¿¡ãƒ†ã‚­ã‚¹ãƒˆ
  Line-->>User: è¿”ä¿¡
```

## ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿â†’é›†è¨ˆï¼‰

```mermaid
sequenceDiagram
  participant User as LIFFãƒ¦ãƒ¼ã‚¶ãƒ¼
  participant UI as review-page UI
  participant Mod as /api/review-moderation
  participant Review as /api/course-reviews
  participant DB as Supabase
  participant BatchE as /api/batch/embeddings/run
  participant BatchR as /api/batch/rollups/run
  participant AI as OpenAI

  User->>UI: ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›
  UI->>Mod: ã‚³ãƒ¡ãƒ³ãƒˆå¯©æŸ»
  Mod->>AI: åˆ¤å®š
  AI-->>Mod: åˆ¤å®šçµæœ
  UI->>Review: ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿
  Review->>DB: users/universities/subjects upsert
  Review->>DB: course_reviews ä¿å­˜
  Review->>DB: embedding_jobs è¿½åŠ 
  Review->>DB: subject_rollups ã‚’ dirty
  BatchE->>DB: embedding_jobs å–å¾—
  BatchE->>AI: Embeddingç”Ÿæˆ
  AI-->>BatchE: embedding
  BatchE->>DB: course_review_embeddings upsert
  BatchR->>DB: subject_rollups é›†è¨ˆ
  BatchR->>AI: summary + rollup embedding
  AI-->>BatchR: summary/embedding
  BatchR->>DB: subject_rollups æ›´æ–°
```

## ä»£è¡¨çš„ãªåˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯

QA ã® tool å¼·åˆ¶åˆ¤å®šã¯ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„çŸ­æ–‡åˆ¤å®šã§ tool_choice ã‚’ required ã«ã—ã¾ã™ã€‚

```ts
function shouldForceTool(userMessage: string) {
  const keywords = ['æˆæ¥­', 'ç§‘ç›®', 'è¬›ç¾©', 'ãŠã™ã™ã‚']; // DBã‚’ä½¿ã†è³ªå•åˆ¤å®š
  return keywords.some((k) => userMessage.toLowerCase().includes(k));
}
```
(å‚ç…§: apps/review-page/app/api/ask/route.ts:168-237)

æ¬¡ã«é€²ã‚€å ´åˆã¯ [ãƒªãƒã‚¸ãƒˆãƒªæ§‹é€ ](./04-ãƒªãƒã‚¸ãƒˆãƒªæ§‹é€ .md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
