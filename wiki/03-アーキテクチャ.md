# ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

## å…¨ä½“åƒ

- LINE Bot ã¨ LIFF ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®å…¥åŠ›ã‚’ review å´ API ãŒé›†ç´„ã—ã€Supabase ã¸ä¿å­˜ã—ã¾ã™ã€‚(report.md:111-133)
- ãƒãƒƒãƒå‡¦ç†ã¯ embeddings / rollups ã‚’åˆ†é›¢ã—ã¦å®Ÿè¡Œã™ã‚‹æ–¹é‡ã§ã™ã€‚(report.md:136-137)

```mermaid
flowchart TD
  User[ãƒ¦ãƒ¼ã‚¶ãƒ¼] -->|LINE/LIFF| Line[LINE Bot]
  Line --> Review[Review API]
  Review --> Supabase[(Supabase DB)]
  Review --> OpenAI[OpenAI]
  Batch[Batch] --> Supabase
```

## ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

### LINE: è³ªå•â†’å›ç­”

```mermaid
sequenceDiagram
  participant User as User (LINE)
  participant Line as LINE Webhook
  participant Ask as Review API (/api/ask)
  participant DB as Supabase
  participant AI as OpenAI

  User->>Line: è³ªå•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  Line->>Ask: Webhookã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
  Ask->>AI: Responses API + tools
  AI-->>Ask: toolå‘¼ã³å‡ºã—è¦æ±‚
  Ask->>DB: Supabaseæ¤œç´¢
  DB-->>Ask: æ¤œç´¢çµæœ
  Ask->>AI: toolçµæœã‚’å…¥åŠ›
  AI-->>Ask: å›ç­”ãƒ†ã‚­ã‚¹ãƒˆ
  Ask-->>Line: è¿”ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  Line-->>User: è¿”ä¿¡è¡¨ç¤º
```

### ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿: ãƒ•ã‚©ãƒ¼ãƒ â†’ä¿å­˜â†’ãƒãƒƒãƒå‡¦ç†

```mermaid
sequenceDiagram
  participant User as User (LINE)
  participant LIFF as LIFFãƒ•ã‚©ãƒ¼ãƒ 
  participant Review as Review API (/api/course-reviews)
  participant Mod as Review Moderation API
  participant DB as Supabase
  participant BatchE as Embeddings Batch
  participant BatchR as Rollups Batch
  participant AI as OpenAI

  User->>LIFF: ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ èµ·å‹•
  LIFF->>Mod: ã‚³ãƒ¡ãƒ³ãƒˆåˆ¤å®š
  Mod->>AI: ã‚³ãƒ¡ãƒ³ãƒˆå¯©æŸ»
  AI-->>Mod: åˆ¤å®šçµæœ
  Mod-->>LIFF: ãƒ•ãƒ©ã‚°/ç†ç”±
  LIFF->>Review: ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿
  Review->>DB: users/universities/subjects upsert
  Review->>DB: course_reviews ä¿å­˜
  Review->>DB: course_review_ai_flags ä¿å­˜
  Review->>DB: embedding_jobs è¿½åŠ 
  Review->>DB: subject_rollups ã‚’ dirty
  Review-->>LIFF: æŠ•ç¨¿å®Œäº†ãƒ¬ã‚¹ãƒãƒ³ã‚¹
  BatchE->>DB: embedding_jobs å–å¾—
  BatchE->>DB: course_reviews æœ¬æ–‡å–å¾—
  BatchE->>AI: Embeddingç”Ÿæˆ
  AI-->>BatchE: embedding
  BatchE->>DB: course_review_embeddings upsert
  BatchR->>DB: subject_rollups é›†è¨ˆ
  BatchR->>DB: reviews æœ¬æ–‡å–å¾—
  BatchR->>AI: summaryç”Ÿæˆ + rollup embedding
  AI-->>BatchR: summary/embedding
  BatchR->>DB: subject_rollups æ›´æ–°
  BatchR->>DB: subject_rollup_embeddings upsert
```

## ãƒ¢ãƒãƒ¬ãƒã®é‹ç”¨

- review å´ã¯ `apps/review-page`ã€line å´ã¯ `apps/line-ai-bot` ã§é‹ç”¨ã—ã¾ã™ã€‚(report.md:13-18)

## ãƒ‡ãƒ—ãƒ­ã‚¤æ§‹æˆï¼ˆline å´ï¼‰

```jsonc
{
  "builds": [{ "src": "api/webhook.js", "use": "@vercel/node" }], // Webhook ã‚’ Node ã§å®Ÿè¡Œ
  "routes": [{ "src": "/api/webhook", "dest": "api/webhook.js" }] // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
}
```
(å‚ç…§: apps/line-ai-bot/vercel.json:1-4)

è©³ç´°ã¯ [ãƒªãƒã‚¸ãƒˆãƒªæ§‹é€ ](./04-ãƒªãƒã‚¸ãƒˆãƒªæ§‹é€ .md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
