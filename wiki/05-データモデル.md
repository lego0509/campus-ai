# ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

## ãƒ¢ãƒ‡ãƒ«æ¦‚è¦

- `users` ã¯ LINE userId ã‚’ HMAC ã§ãƒãƒƒã‚·ãƒ¥åŒ–ã—ãŸ `line_user_hash` ã®ã¿ã‚’ä¿æŒã—ã¾ã™ã€‚(å‚ç…§: wiki/ddl-context.sql:214-219, apps/review-page/lib/lineUserHash.ts:1-7)
- æˆæ¥­ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ä¼æ¥­ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã§ä¿æŒã—ã€é›†è¨ˆç”¨ rollup ãƒ†ãƒ¼ãƒ–ãƒ«ã¸éåŒæœŸã§åæ˜ ã—ã¾ã™ã€‚(å‚ç…§: wiki/ddl-context.sql:52-108, 150-210)

## ER å›³ï¼ˆä¸»è¦é–¢ä¿‚ï¼‰

```mermaid
erDiagram
  USERS ||--o{ CHAT_MESSAGES : writes
  USERS ||--o| USER_AFFILIATIONS : has
  USERS ||--o| USER_MEMORY : owns
  USERS ||--o{ COURSE_REVIEWS : writes
  USERS ||--o{ COMPANY_REVIEWS : writes

  UNIVERSITIES ||--o{ SUBJECTS : offers
  UNIVERSITIES ||--o{ COURSE_REVIEWS : has
  UNIVERSITIES ||--o{ COMPANY_REVIEWS : has

  SUBJECTS ||--o{ COURSE_REVIEWS : has
  SUBJECTS ||--|| SUBJECT_ROLLUPS : aggregates

  COURSE_REVIEWS ||--|| COURSE_REVIEW_EMBEDDINGS : embeds
  COURSE_REVIEWS ||--|| COURSE_REVIEW_AI_FLAGS : flags
  COURSE_REVIEWS ||--|| EMBEDDING_JOBS : queues

  SUBJECT_ROLLUPS ||--|| SUBJECT_ROLLUP_EMBEDDINGS : embeds

  COMPANIES ||--o{ COMPANY_REVIEWS : has
  COMPANY_REVIEWS ||--|| COMPANY_REVIEW_EMBEDDINGS : embeds
  COMPANY_REVIEWS ||--|| COMPANY_REVIEW_AI_FLAGS : flags
  COMPANY_REVIEWS ||--|| COMPANY_EMBEDDING_JOBS : queues

  COMPANY_ROLLUPS ||--|| COMPANY_ROLLUP_EMBEDDINGS : embeds
```

## ã‚³ã‚¢ãƒ†ãƒ¼ãƒ–ãƒ«

### users / user_affiliations

```sql
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT gen_random_uuid(), -- ä¸»ã‚­ãƒ¼
  line_user_hash character NOT NULL UNIQUE,   -- LINE userId ã®ãƒãƒƒã‚·ãƒ¥
  created_at timestamp with time zone NOT NULL DEFAULT now()
);
```
(å‚ç…§: wiki/ddl-context.sql:214-219)

```sql
CREATE TABLE public.user_affiliations (
  user_id uuid NOT NULL,
  university_id uuid NOT NULL,
  faculty text NOT NULL,
  department text
);
```
(å‚ç…§: wiki/ddl-context.sql:196-205)

### universities / subjects

```sql
CREATE TABLE public.universities (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE
);
```
(å‚ç…§: wiki/ddl-context.sql:186-191)

```sql
CREATE TABLE public.subjects (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  university_id uuid NOT NULL,
  name text NOT NULL
);
```
(å‚ç…§: wiki/ddl-context.sql:176-183)

### course_reviews

```sql
CREATE TABLE public.course_reviews (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  subject_id uuid NOT NULL,
  grade_at_take integer NOT NULL,   -- 1..6 or 99
  term text NOT NULL,               -- s1/s2/q1.../other
  body_main text NOT NULL           -- æœ¬æ–‡
);
```
(å‚ç…§: wiki/ddl-context.sql:120-149)

### company_reviews

```sql
CREATE TABLE public.company_reviews (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  university_id uuid NOT NULL,
  company_id uuid NOT NULL,
  grad_year integer NOT NULL,
  outcome text NOT NULL,
  body_main text NOT NULL
);
```
(å‚ç…§: wiki/ddl-context.sql:52-71)

## AI/Embedding é–¢é€£

- `course_review_embeddings` / `company_review_embeddings`: ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬æ–‡ã® embedding ã‚’ä¿å­˜ã€‚
- `subject_rollup_embeddings` / `company_rollup_embeddings`: é›†è¨ˆè¦ç´„ã® embedding ã‚’ä¿å­˜ã€‚
- `course_review_ai_flags` / `company_review_ai_flags`: ä¸é©åˆ‡åˆ¤å®šã®è¨˜éŒ²ã€‚
- `embedding_jobs` / `company_embedding_jobs`: embedding ç”Ÿæˆã‚­ãƒ¥ãƒ¼ã€‚

```sql
CREATE TABLE public.embedding_jobs (
  review_id uuid NOT NULL,
  status text NOT NULL DEFAULT 'queued', -- queued/processing/done/failed
  attempt_count integer NOT NULL DEFAULT 0
);
```
(å‚ç…§: wiki/ddl-context.sql:150-160)

## é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆRollupsï¼‰

```sql
CREATE TABLE public.subject_rollups (
  subject_id uuid NOT NULL,
  summary_1000 text NOT NULL DEFAULT '',
  review_count integer NOT NULL DEFAULT 0,
  avg_satisfaction numeric,
  is_dirty boolean NOT NULL DEFAULT false
);
```
(å‚ç…§: wiki/ddl-context.sql:162-174)

```sql
CREATE TABLE public.company_rollups (
  university_id uuid NOT NULL,
  faculty text NOT NULL,
  company_id uuid NOT NULL,
  summary_1000 text NOT NULL DEFAULT '',
  review_count integer NOT NULL DEFAULT 0,
  is_dirty boolean NOT NULL DEFAULT false
);
```
(å‚ç…§: wiki/ddl-context.sql:92-108)

## åˆ¶ç´„ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¦ç‚¹

- `course_reviews.term` ã¯ s1/s2/q1/q2/q3/q4/full/intensive/other ã®ã¿ã€‚(å‚ç…§: wiki/ddl-context.sql:127-133)
- `course_reviews.grade_at_take` ã¯ 1..6 ã‹ 99 (ä¸æ˜)ã€‚(å‚ç…§: wiki/ddl-context.sql:125-126)
- `company_reviews.outcome` ã¯ offer/rejected/otherã€‚(å‚ç…§: wiki/ddl-context.sql:59-60)
- `company_reviews.selection_types` ã¯ ES/ãƒ†ã‚¹ãƒˆ/é¢æ¥/GD/èª²é¡Œ/ãã®ä»–ã®é…åˆ—ã€‚(å‚ç…§: wiki/ddl-context.sql:63-64)

## é‡è¦ãªé‹ç”¨ä¸Šã®è£œè¶³

- `company_rollup_embeddings` ã¯ DDL ä¸Šã§å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãŒé‡è¤‡ã—ã¦ãŠã‚Šã€å®Ÿé‹ç”¨ã§ã¯ (university_id, faculty, company_id) ã®è¤‡åˆå‚ç…§ã¨ã—ã¦æ‰±ã†å‰æã§è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚(å‚ç…§: wiki/ddl-context.sql:72-90)
- `line_user_hash` ç”Ÿæˆã¯ HMAC-SHA256 ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚(å‚ç…§: apps/review-page/lib/lineUserHash.ts:1-7)

æ¬¡ã«é€²ã‚€å ´åˆã¯ [ã‚³ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](./06-ã‚³ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
