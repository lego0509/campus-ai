# ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

## ãƒ¢ãƒ‡ãƒ«æ–¹é‡

- LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ `users.line_user_hash` ã«ä¿å­˜ã—ã¾ã™ã€‚(report.md:81-83)
- 1ãƒ¦ãƒ¼ã‚¶ãƒ¼=1ã‚¹ãƒ¬ãƒƒãƒ‰ã®ä¼šè©±ãƒ­ã‚°ã‚’ `chat_messages` ã«ä¿å­˜ã—ã¾ã™ã€‚(report.md:83-86)

## ER å›³ï¼ˆè¦ç´„ï¼‰

```mermaid
erDiagram
  USERS ||--o{ USER_AFFILIATIONS : has
  USERS ||--o{ CHAT_MESSAGES : writes
  USERS ||--|| USER_MEMORY : owns
  UNIVERSITIES ||--o{ SUBJECTS : offers
  SUBJECTS ||--o{ COURSE_REVIEWS : has
  COURSE_REVIEWS ||--|| COURSE_REVIEW_EMBEDDINGS : embeds
  COURSE_REVIEWS ||--|| COURSE_REVIEW_AI_FLAGS : flags
  SUBJECTS ||--|| SUBJECT_ROLLUPS : aggregates
```

## ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆDDLæŠœç²‹ï¼‰

```sql
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT gen_random_uuid(), -- ä¸»ã‚­ãƒ¼
  line_user_hash character NOT NULL UNIQUE,   -- LINE userId ã®ãƒãƒƒã‚·ãƒ¥
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT users_pkey PRIMARY KEY (id)
);

CREATE TABLE public.course_reviews (
  id uuid NOT NULL DEFAULT gen_random_uuid(), -- ä¸»ã‚­ãƒ¼
  user_id uuid NOT NULL,                      -- users.id
  subject_id uuid NOT NULL,                   -- subjects.id
  academic_year integer NOT NULL,
  term text NOT NULL,
  body_main text NOT NULL,
  CONSTRAINT course_reviews_pkey PRIMARY KEY (id)
);
```
(å‚ç…§: report.md:361-386,463-468)

## ãƒãƒƒãƒé–¢é€£

- `embedding_jobs` ãŒ embeddings å‡¦ç†ã®ã‚­ãƒ¥ãƒ¼å½¹ã§ã™ã€‚(report.md:387-398)
- `subject_rollups` / `subject_rollup_embeddings` ãŒé›†è¨ˆãƒ»è¦ç´„ã®å‡ºåŠ›å…ˆã§ã™ã€‚(report.md:399-428)

æ¬¡ã«é€²ã‚€å ´åˆã¯ [ã‚³ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](./06-ã‚³ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
